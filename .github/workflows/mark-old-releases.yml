name: Mark Outdated Releases
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  mark-outdated:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Update old releases
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log("ğŸš€ [Start] ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘");
            console.log(`â„¹ï¸ Event Type: ${context.eventName}`);

            const markerRegex = /<!--MARKER[\s\S]*?<!--MARKER_END-->/;
            const markerStart = '<!--MARKER(v1.1)-->';
            const header = '# âš ï¸ì´ ë²„ì „ì€ ìµœì‹  ë²„ì „ì´ ì•„ë‹™ë‹ˆë‹¤.';
            const content = '**[ìµœì‹  ë²„ì „ ë‹¤ìš´ë¡œë“œ](https://github.com/byungmeo/GersangStation/releases/latest)**';
            const markerEnd = '<!--MARKER_END-->';
            const NEW_CONTENT_BLOCK = `${markerStart}\n${header}\n${content}\n${markerEnd}\n`;

            // 1. ë¦´ë¦¬ì¦ˆ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            console.log("ğŸ”„ ë¦´ë¦¬ì¦ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
            const releases = await github.paginate(github.rest.repos.listReleases, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            console.log(`âœ… ì´ ${releases.length}ê°œì˜ ë¦´ë¦¬ì¦ˆë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);

            // 2. ë³´í˜¸í• (êµ¬ì‹ ì²˜ë¦¬ ì•ˆ í• ) ìµœì‹  ë²„ì „ ID ì°¾ê¸°
            let currentReleaseId = null;
            let currentReleaseTag = "Unknown";

            if (context.payload && context.payload.release) {
              // ìë™ íŠ¸ë¦¬ê±°
              currentReleaseId = context.payload.release.id;
              currentReleaseTag = context.payload.release.tag_name || context.payload.release.name;
              console.log(`ğŸ¯ [Auto Trigger] ë°©ê¸ˆ ìƒì„±ëœ ë¦´ë¦¬ì¦ˆë¥¼ ë³´í˜¸í•©ë‹ˆë‹¤ (ID: ${currentReleaseId}, Tag: ${currentReleaseTag})`);
            } else if (releases.length > 0) {
              // ìˆ˜ë™ íŠ¸ë¦¬ê±°
              currentReleaseId = releases[0].id;
              currentReleaseTag = releases[0].tag_name || releases[0].name;
              console.log(`ğŸ¯ [Manual Trigger] ëª©ë¡ì˜ ì²« ë²ˆì§¸(ìµœì‹ ) ë¦´ë¦¬ì¦ˆë¥¼ ë³´í˜¸í•©ë‹ˆë‹¤ (ID: ${currentReleaseId}, Tag: ${currentReleaseTag})`);
            } else {
              console.log("âš ï¸ ì²˜ë¦¬í•  ë¦´ë¦¬ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.");
              return;
            }

            // 3. ìˆœíšŒí•˜ë©° ì—…ë°ì´íŠ¸
            console.log("---------------------------------------------------");
            for (const release of releases) {
              const releaseTag = release.tag_name || release.name || "No Name";
              console.log(`ğŸ” ê²€ì‚¬ ì¤‘: [${releaseTag}] (ID: ${release.id})`);

              // Case A: ìµœì‹  ë²„ì „(ë˜ëŠ” ë°©ê¸ˆ ë§Œë“  Draft)ì¸ ê²½ìš°
              if (release.id === currentReleaseId) {
                console.log(`   â­ï¸ SKIP: í˜„ì¬ ìµœì‹  ë²„ì „ì´ë¯€ë¡œ ê±´ë„ˆëœë‹ˆë‹¤.`);
                continue;
              }

              let currentBody = release.body || "";
              let updatedBody = "";

              if (markerRegex.test(currentBody)) {
                // ì´ë¯¸ ë§ˆì»¤ê°€ ìˆëŠ” ê²½ìš°
                if (currentBody.includes(markerStart)) {
                  console.log(`ğŸ” [${releaseTag}] SKIP: ì´ë¯¸ ìµœì‹  ë§ˆì»¤(${markerStart})ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.`);
                  continue;
                } else {
                  // êµ¬ë²„ì „ ë§ˆì»¤ê°€ ìˆë‹¤ë©´ êµì²´
                  console.log(`ğŸ” [${releaseTag}] UPDATE: ë§ˆì»¤ ë²„ì „ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.`);
                  updatedBody = currentBody.replace(markerRegex, NEW_CONTENT_BLOCK);
                }
              } else {
                // ë§ˆì»¤ê°€ ì—†ëŠ” ê²½ìš° ìƒë‹¨ì— ì¶”ê°€
                console.log(`ğŸ” [${releaseTag}] ADD: ë§ˆì»¤ë¥¼ ìƒˆë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.`);
                updatedBody = `${NEW_CONTENT_BLOCK}\n\n${currentBody}`;
              }

              // Case C: ì—…ë°ì´íŠ¸ ëŒ€ìƒ
              console.log(`   âœï¸ UPDATE: êµ¬ì‹ ë²„ì „ ë¬¸êµ¬ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤...`);
              try {
                await github.rest.repos.updateRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.id,
                  body: updatedBody
                });
                console.log(`   âœ… ì„±ê³µ: [${releaseTag}] ì—…ë°ì´íŠ¸ ì™„ë£Œ.`);
              } catch (error) {
                console.error(`   âŒ ì‹¤íŒ¨: [${releaseTag}] ì—…ë°ì´íŠ¸ ì¤‘ ì—ëŸ¬ ë°œìƒ!`);
                console.error(error);
              }
            }
            console.log("---------------------------------------------------");
            console.log("ğŸ [End] ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
